# Enhanced Features Design: Rolling Statistics + Event Lead/Lag Indicators

**Date:** 2026-01-05
**Goal:** Improve XGBoost_Enhanced model by adding rolling statistics and event anticipation/aftermath features

## Summary

Add 21 new features to the model:
- 6 rolling statistics (already generated, just include in model)
- 9 lead indicators (events upcoming in 1-3 days)
- 6 lag indicators (events occurred 1-2 days ago)

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Rolling target columns | daily_logins only | Focus on prediction target |
| Lead indicator window | 1-3 days ahead | Captures betting anticipation period |
| Lag indicator window | 1-2 days after | Post-event effects are shorter |
| Event scope | Hybrid (aggregated + bank_holiday + football) | High-impact events get specific indicators |

## New Features

### Rolling Statistics (6 features)
Already generated by `RollingFeatures`, just add to `EXTERNAL_FEATURES`:
- `daily_logins_rolling_mean_7`, `_14`, `_30`
- `daily_logins_rolling_std_7`, `_14`, `_30`

### Lead Indicators (9 features)
```
any_event_tomorrow, any_event_in_2_days, any_event_in_3_days
bank_holiday_tomorrow, bank_holiday_in_2_days, bank_holiday_in_3_days
football_tomorrow, football_in_2_days, football_in_3_days
```

### Lag Indicators (6 features)
```
any_event_yesterday, any_event_2_days_ago
bank_holiday_yesterday, bank_holiday_2_days_ago
football_yesterday, football_2_days_ago
```

## Files to Modify

1. **`src/volume_forecast/features/events.py`**
   - Add lead/lag indicator generation after existing event population
   - Build date sets for efficient lookups
   - Add 15 new binary feature columns

2. **`tests/unit/test_features.py`**
   - Test lead indicators (event_tomorrow = 1 when next day has event)
   - Test lag indicators (event_yesterday = 1 when previous day had event)
   - Test bank holiday and football specific indicators

3. **`notebooks/07_model_comparison.ipynb`**
   - Update EXTERNAL_FEATURES list (34 total features)
   - Update PROPHET_REGRESSORS list

## Implementation Approach

In `EventFeatures.transform()`:
1. Build event date sets after populating event_lookup:
   - `all_event_dates: set[date]`
   - `bank_holiday_dates: set[date]`
   - `football_dates: set[date]`

2. For each row, compute lead indicators:
   ```python
   row_date = pd.to_datetime(row[date_column]).date()
   df.at[idx, 'any_event_tomorrow'] = 1 if (row_date + timedelta(days=1)) in all_event_dates else 0
   ```

3. Same pattern for lag indicators using subtraction

## Expected Outcome

Current XGBoost_Enhanced: 10.25% MAPE
Target: < 9% MAPE with enhanced features
